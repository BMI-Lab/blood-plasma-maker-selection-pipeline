# Blood Plasma Marker Selection Pipeline
This is an example pipeline implementing the ideas introduced in [our paper](link TBD).

Specifically, this repository contains
1. `bpmsp.R`, pipeline functions implemented using R.
2. `human_protein_atlas`, a directory containing tsv data files sourced from 
[The Human Protein Atlas](https://www.proteinatlas.org/).
3. `breast_cancer_example.Rmd` an R notebook demonstrating how the pipeline functions are used.
4. `breast_cancer_example.html` the HTML file generated by RStudio, showing the commands and outputs.
5. `breast_cancer_example.pdf` the PDF file printed from `breast_cancer_example.html`, showing the 
   commands and outputs.

## How to run the pipeline example locally
### Prerequisite
1. RStudio (Docker)<br>
The pipeline was developed in RStudio in Linux where `zcat`, `awk`, `head`, `zgrep` and `wget`
commands were available. For an easy setup, we recommend installing Docker to run 
an RStudio server instance in your localhost. Once you have `docker` installed, you could fetch the 
docker image by this command: 
    ```shell
    docker pull rocker/rstudio:4.1
    ```
2. You have access to the Internet to visit e.g., https://www.gtexportal.org/home/datasets 
3. You have the `git` command installed.

### Step 1: Clone this git repository
```shell
git clone https://github.com/BMI-Lab/blood-plasma-maker-selection-pipeline.git
```
We will refer your local directory where you cloned the repo as `${BPMSP_HOME}`.

**Note:** Some Docker Desktop version (e.g. 3.6 for Mac) was able to handle file system permissions seamlessly.
If, by any chance, you run into file permission issues in the next steps, you might need to 
explicitly grant the _rstudio_ user (used by the docker container) the read and write access to this directory and 
all its contents.

### Step 2: Launch RStudio in Docker
Before launching RStudio from Docker, please adjust the "Resources" settings in your Docker Desktop
"Preferences". It is recommended to allow at least 4 CPU, 4 GB memory and 2 GB swap.

You could then use the shell command below to launch an RStudio server instance in your **localhost only**. 
Note that the shell command separator is for Linux or Mac OSX. 
The docker command will also mount the `${BPMSP_HOME}` directory under the default _rstudio_ user's home directory.

**WARNING:** Never disable authentication if you plan to expose the RStudio server to the public. Please see the 
[docker image homepage](https://hub.docker.com/r/rocker/rstudio) for more details on authentication.

```shell
docker run -d -e PASSWORD=${pswd} -p 8787:8787 -e DISABLE_AUTH=true \
  -v ${BPMSP_HOME}:/home/rstudio/blood-plasma-maker-selection-pipeline \
  --name rstudio rocker/rstudio:4.1
```

### Step 3: Run the example in RStudio
1. Open the hyperlink http://localhost:8787/ in a browser and you will be automatically logged into RStudio web 
   portal with the default user name _rstudio_. <br><br>
2. In the "Console" tab, also set the working directory by running this R function:
`setwd('/home/rstudio/blood-plasma-maker-selection-pipeline')`
<br><br>
3. In the "File" tab, click "blood-plasma-maker-selection-pipeline" to open the directlry, then click 
   the R Markdown file `breast_cancer_example.Rmd`. <br>
   **Note:** If RStudio prompts you to update the required libraries, accept the suggestion. <br><br>
4. To generate the preview HTML file yourself for the very first time, we recommend running the first two chunks 
   manually until the second chunk (section 1.2) passes successfully. This is because in the section `1.2 Loading the 
   data sets` in `breast_cancer_example.Rmd` needs time to download near 3G data from the Internet. So if the download 
   speed from your location is very slow and caused timeouts, you might need to retry as instructed in that section. 
   <br><br>
   Once the first two chunks have finished successfully, you can then run all the chunks. As long as you do not 
   remove the already downloaded files, re-run will not attempt to download them again and thus be much faster. 